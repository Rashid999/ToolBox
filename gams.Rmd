---
title: "<strong>Generalized Additive Models</strong>"
author: "andrés castro araújo"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
  html_document: 
    theme: paper
    toc: yes
    toc_float:
      collapsed: yes
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "", fig.align = "center",
                      fig.width = 8, fig.height = 8)

library(tidyverse)

theme_custom <- function(base_line_size = 0.25) {
  theme_minimal(base_family = "IBM Plex Sans", base_line_size = base_line_size) +
    theme(
      plot.title = element_text(face = "bold"),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(size = base_line_size),
      strip.background = element_rect(fill = "gray80", color = "gray80")
    ) 
}
theme_set(theme_custom())
```

```{css, echo=FALSE}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 14px;
    color: #828282;
    border-left: 10px solid #EEE;
}
body {
    font-size: 14px;
}
```

>All of this is taken from Noam Ross' online course, [___Generalized Additive Models in R___](https://noamross.github.io/gams-in-r-course/). 

****

## Introduction

In terms of interpretability, Generalized Additive Models (GAMs) are a middle-ground between linear regression and black-box types of machine learning.

_Hello world!_

```{r, fig.height=4, fig.width=5}
N <- 1e3
x <- runif(N, 1, 200)
y <- rnorm(N, mean = cos(0.05*x), sd = 0.5)

tibble(x, y) %>% 
  ggplot(aes(x, y)) + 
  geom_point() +
  geom_smooth(method = mgcv::gam, formula = y ~ s(x)) + 
  stat_function(fun = function(x) cos(0.05*x), linetype = "dashed", color = "red")
```

>We fit a GAM using the `gam()` function from the mgcv package. Here, when we fit this GAM, we wrap the independent variable, `x`, in the `s()`, that is smooth function to specify that we want this relationship to be flexible. A GAM can capture the nonlinear aspects of not only this relationship, but of many nonlinear relationships, because of the flexibility of ___splines___.

>The flexible smooths in GAMs are actually constructed of many smaller functions. These are called __basis functions__. Each smooth is the sum of a number of basis functions, and each basis function is multiplied by a coefficient, each of which is a parameter in the model. In the plot here on the left, we show the basis functions of a GAM where all the coefficients are the same. On the right, we show the same basis functions after model-fitting, where each has a coefficient fit to the data. You can see how these basis functions add up to create the overall smooth shape. So a single nonlinear relationship between a dependent and independent variable has several parameters, plus an intercept. This is different, and more complex, than a linear model, where each variable has only a single coefficient or parameter.

```{r, echo=FALSE, out.width="80%"}
knitr::include_graphics(
"https://github.com/noamross/gams-in-r-course/blob/master/images/basis-functions-1.png?raw=true"
)
```

```{r, message=FALSE}
library(mgcv)

tibble(x, y) %>% head()
model.matrix(gam(y ~ s(x))) %>% head()
model.matrix(gam(y ~ s(x))) %>% dim()

gam_mod <- gam(y ~s(x))
gam_mod
coefficients(gam_mod)
```

## Basis Functions

How do GAMs navigate the tradeoff under-fitting and over-fitting? GAMs penalize the "complexity" or "wiggliness" of the fitted model. 

$$
\text{fit} = \text{likelihood} - \lambda \ \text{wiggliness} \hspace{1cm} \text{where} \ \lambda = \text{smoothing parameter}
$$

__The smoothing parameter__

```{r, fig.height=4, fig.width=5}
large_sp <- gam(y ~ s(x, sp = 100))         ## sp too large
reml_sp <- gam(y ~ s(x), method = "REML")   ## restricted via maximul likelihood

tibble(x, y, large = predict(large_sp), reml = predict(reml_sp)) %>% 
  ggplot(aes(x, y)) + 
  geom_point() + 
  geom_line(aes(y = large, color = "lambda = 100")) + 
  geom_line(aes(y = reml, color = "REML")) + 
  theme(legend.position = "top") + 
  labs(color = "smoothing parameter")
```

>In addition to the smoothing parameter, the other factor that affects how wiggly a GAM function can be is the number of basis functions that make up a smooth function.

```{r, echo=FALSE, out.width="80%"}
knitr::include_graphics(
"https://github.com/noamross/gams-in-r-course/blob/master/images/diffbasis-1.png?raw=true"
)
```

>As you can see, a smooth with a small number of basis functions is limited in its wiggliness, while one with many basis functions is capable of capturing finer patterns.


```{r, fig.height=4, fig.width=5}
k3 <- gam(y ~ s(x, k = 3), method = "REML") %>% predict()
k15 <- gam(y ~ s(x, k = 15), method = "REML") %>% predict()

tibble(x, y, k3, k15) %>% 
  ggplot(aes(x, y)) + 
  geom_point() + 
  geom_line(aes(y = k3, color = "k = 3")) + 
  geom_line(aes(y = k10, color = "k = 15")) + 
  theme(legend.position = "top") + 
  labs(color = "smoothing parameter")
```

>Setting this value too low will prevent the model from being sufficiently wiggly. If it's high, though, the automatic smoothing parameter selection will prevent it from being too wiggly. We just don't want to set it very high, which can result in a model with more parameters than data, or one that is slow to fit.

## Multiple Regression

```{r}

```


